<div class="min-h-screen bg-gray-50 p-6">
    <!-- Filtros Card -->
    <div @fadeInUp class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
        <div class="p-6">
            <!-- Campos de filtro -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-1">
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>
                        <mat-icon class="text-primary mr-1" svgIcon="mat:business"></mat-icon>
                        Gerencia/División
                    </mat-label>
                    <mat-select [formControl]="formGroup.controls.division" (selectionChange)="listarPerfilesPorDivision($event)">
                        <mat-option *ngFor="let obj of listDivision" [value]="obj">
                            {{ obj.deDivision }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>
                        <mat-icon class="text-primary mr-1" svgIcon="mat:person"></mat-icon>
                        Perfil
                    </mat-label>
                    <input [formControl]="formGroup.controls.perfil" [matAutocomplete]="autoTecnico" matInput (blur)="blurEvaluadorTecnico()" placeholder="Seleccione un perfil">
                    <mat-autocomplete #autoTecnico="matAutocomplete" [displayWith]="displayFn">
                        <mat-option *ngFor="let state of filteredStatesTecnico$ | async" [value]="state" class="custom-option">
                            <span class="body-1">{{ state.dePerfil }}</span>
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>
                        <mat-icon class="text-primary mr-1" svgIcon="mat:event"></mat-icon>
                        Fecha Inicio
                    </mat-label>
                    <input [formControl]="formGroup.controls.fechaInicio" type="date" min="1900-01-01" max="{{dateHoy | date:'yyyy-MM-dd'}}" matInput />
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>
                        <mat-icon class="text-primary mr-1" svgIcon="mat:event_available"></mat-icon>
                        Fecha Fin
                    </mat-label>
                    <input [formControl]="formGroup.controls.fechaFin" type="date" [min]="getFechaMinima()" matInput />
                    <mat-error *ngIf="formGroup.get('fechaFin').hasError('fechaInvalida')" class="text-red-600 text-xs">
                        La fecha fin no puede ser menor a la fecha inicio
                    </mat-error>
                </mat-form-field>
            </div>

            <!-- Botones de acción -->
            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                <button 
                    color="primary" 
                    mat-raised-button 
                    type="button" 
                    (click)="crearRequerimiento(ACC_NUEVO_REQUERIMIENTO)">
                    <mat-icon class="mr-2" svgIcon="mat:add"></mat-icon>
                    Nuevo
                </button>
                <button 
                    color="primary" 
                    mat-raised-button 
                    type="button" 
                    (click)="buscar()">
                    <mat-icon class="mr-2" svgIcon="mat:search"></mat-icon>
                    Buscar
                </button>
                <button 
                    color="primary" 
                    mat-raised-button
                    type="button" 
                    (click)="limpiar()">
                    <mat-icon class="mr-2" svgIcon="mat:clear"></mat-icon>
                    Limpiar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabla Card -->
    <div class="rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <!-- Tabla -->
        <div class="overflow-x-auto">
            <table @stagger [dataSource]="dataSource" class="w-full" mat-table matSort>
                <!-- Columna Expediente -->
                <ng-container matColumnDef="nuExpediente">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3">
                        <div class="flex items-center">
                            Número de Expediente
                        </div>
                    </th>
                    <td mat-cell *matCellDef="let element" class="px-4 py-3 border-b border-gray-100">
                        <span class="font-medium">{{ element?.nuExpediente }}</span>
                    </td>
                </ng-container>

                <!-- Columna Fecha Registro -->
                <ng-container matColumnDef="feRegistro">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3">
                        <div class="flex items-center">
                            Fecha del Requerimiento
                        </div>
                    </th>
                    <td mat-cell *matCellDef="let element" class="px-4 py-3 border-b border-gray-100">
                        <span class="text-gray-700">{{ element?.feRegistro }}</span>
                    </td>
                </ng-container>

                <!-- Columna División -->
                <ng-container matColumnDef="deDivision">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3">
                        <div class="flex items-center">
                            Gerencia/División
                        </div>
                    </th>
                    <td mat-cell *matCellDef="let element" class="px-4 py-3 border-b border-gray-100">
                        <span class="text-gray-700">{{ element?.division?.deDivision }}</span>
                    </td>
                </ng-container>

                <!-- Columna Perfil -->
                <ng-container matColumnDef="perfil">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3">
                        <div class="flex items-center">
                            Perfil
                        </div>
                    </th>
                    <td mat-cell *matCellDef="let element" class="px-4 py-3 border-b border-gray-100">
                        <span class="text-gray-700">{{ element?.perfil?.nombre }}</span>
                    </td>
                </ng-container>

                <!-- Columna Nombres y Apellidos -->
                <ng-container matColumnDef="nombresApellidos">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3">
                        <div class="flex items-center">
                            Nombres y Apellidos
                        </div>
                    </th>
                    <td mat-cell *matCellDef="let element" class="px-4 py-3 border-b border-gray-100">
                        <span class="text-gray-700 font-medium">{{ element?.nombresApellidos }}</span>
                    </td>
                </ng-container>

                <!-- Columna Estado -->
                <ng-container matColumnDef="estado">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3">
                        <div class="flex items-center">
                            Estado
                        </div>
                    </th>
                    <td mat-cell *matCellDef="let element" class="px-4 py-3 border-b ">
                        <span class="text-gray-700 font-medium">
                            {{ element?.estado?.nombre }}
                        </span>
                    </td>
                </ng-container>

                <!-- Columna Acciones -->
                <ng-container matColumnDef="acciones">
                    <th mat-header-cell *matHeaderCellDef class="font-semibold px-4 py-3 w-20">
                        <div class="flex items-center">
                            Acciones
                        </div>
                    </th>
                    <td mat-cell *matCellDef="let row" class="border-b border-gray-100">
                        <button 
                            (click)="$event.stopPropagation()"
                            [matMenuTriggerData]="{ customer: row }"
                            [matMenuTriggerFor]="actionsMenu"
                            mat-icon-button
                            *ngIf="accionesEnabled(row)"
                            type="button">
                            <mat-icon svgIcon="mat:more_vert"></mat-icon>
                        </button>
                    </td>
                </ng-container>

                <!-- Estado de carga -->
                <ng-container matColumnDef="loading">
                    <td mat-footer-cell *matFooterCellDef colspan="7" class="text-center py-12">
                        <div class="flex flex-col items-center">
                            <p class="text-gray-600 font-medium">Cargando datos...</p>
                        </div>
                    </td>
                </ng-container>

                <!-- Estado vacío -->
                <ng-container matColumnDef="vacio">
                    <td mat-footer-cell *matFooterCellDef colspan="7" class="text-center py-12">
                        <div class="flex flex-col items-center">
                            <mat-icon class="text-gray-400 mb-4" svgIcon="mat:search_off" style="font-size: 48px; width: 48px; height: 48px;"></mat-icon>
                            <p class="text-gray-600 font-medium mb-2">No se encuentran resultados</p>
                            <p class="text-gray-500 text-sm">Intenta ajustar los filtros de búsqueda</p>
                        </div>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns" 
                    class="hover:bg-gray-50 transition-colors duration-200 cursor-pointer"></tr>
                <tr mat-footer-row *matFooterRowDef="['loading']" [ngClass]="{ 'hidden': dataSource != null }"></tr>
                <tr mat-footer-row *matFooterRowDef="['vacio']" [ngClass]="{ 'hidden': !(dataSource != null && dataSource.data.length == 0) }"></tr>
            </table>
        </div>

        <!-- Paginador -->
        <div class="border-t border-gray-200">
            <mat-paginator 
                [pageSizeOptions]="[10, 20, 30]" 
                (page)="pageChange($event)" 
                showFirstLastButtons
                class="bg-transparent">
            </mat-paginator>
        </div>
    </div>
</div>

<!-- Menú de acciones -->
<mat-menu #actionsMenu="matMenu" xPosition="before" yPosition="below" class="action-menu">
    <ng-template let-row="customer" matMenuContent>
        <button 
            (click)="elaborarInforme(row)" 
            *ngIf="mostrarOpcion(ACC_ELABORAR_INFORME, row)" 
            mat-menu-item
            class="flex items-center px-4 py-3 hover:bg-blue-50">
            <mat-icon class="mr-3" svgIcon="mat:edit"></mat-icon>
            <span class="font-medium">Elaborar Informe</span>
        </button>
        <button 
            (click)="enviarInvitacion(row)" 
            *ngIf="mostrarOpcion(ACC_ENVIAR_INVITACION, row)" 
            mat-menu-item
            class="flex items-center px-4 py-3 hover:bg-green-50">
            <mat-icon class="mr-3" svgIcon="mat:send"></mat-icon>
            <span class="font-medium">Invitación S4</span>
        </button>
        <button 
            (click)="archivarRequerimiento(row)" 
            *ngIf="mostrarOpcion(ACC_ARCHIVAR_REQUERIMIENTO, row)" 
            mat-menu-item
            class="flex items-center px-4 py-3 hover:bg-orange-50">
            <mat-icon class="mr-3" svgIcon="mat:archive"></mat-icon>
            <span class="font-medium">Archivar Requerimiento</span>
        </button>
    </ng-template>
</mat-menu>